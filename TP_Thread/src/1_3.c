#include <stdio.h>
#include <stdlib.h>
#include <pthread.h>
#include <semaphore.h>
#include <unistd.h>
#include <stdint.h>

#define N_THREAD 5
#define P(v) sem_wait(&v)
#define V(v) sem_post(&v)

void* thread(int i);
void* tbarrier(int i);
pthread_t threads[N_THREAD];

int main(){
    int i;
    srand(time(NULL));
    pthread_t barrier_thread;
    pthread_create(&barrier_thread, NULL, tbarrier, NULL);

    for(i = 0; i < N_THREAD; i++){
        pthread_create(&threads[i], NULL, thread, (void *)(intptr_t)(i+1)); 
    }
    
    pthread_join(barrier_thread, NULL);
    return 0;
}

void* thread(int i)
{
    int random_time = rand() % 10;
    usleep(random_time);
    printf("[thread %d] Point atteint\n", (int)i);
    return NULL;
}

void* tbarrier(int i)
{
    printf("[b_thread] Barrière atteinte, en attente…\n");
    for (i = 0; i < N_THREAD; i++) {
        pthread_join(threads[i], NULL);
    }
    printf("[b_thread] Je peux continuer\n");	
	return NULL;
}