#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>

#define BUFFER_SIZE 25
#define MAX_TOUR 5

int main() {
    int fd1[2], fd2[2];
    pid_t pid;

    // Création des pipes
    if (pipe(fd1) == -1 || pipe(fd2) == -1) {
        printf("Erreur lors de la création des pipes.\n");
        exit(1);
    }

    // Création du processus fils
    pid = fork();

    if (pid < 0) {
        printf("Erreur lors de la création du processus fils.\n");
        exit(1);
    }

    // Processus fils
    else if (pid == 0) {
        char buffer[BUFFER_SIZE];
        int nombre_aleatoire, choix_joueur, nombre_tours = 0;

        close(fd1[1]);
        close(fd2[0]);

        // Génération d'un nombrfe aléatoire entre 1 et 10
        srand(getpid());
        nombre_aleatoire = (rand() % 10) + 1;

        while (1) {
            // Lecture du choix du joueur
            read(fd1[0], buffer, BUFFER_SIZE);
            choix_joueur = atoi(buffer);

            // Comparaison avec le nombre aléatoire
            if (choix_joueur < nombre_aleatoire) {
                write(fd2[1], "plus grand\n", 12);
            } else if (choix_joueur > nombre_aleatoire) {
                write(fd2[1], "plus petit\n", 12);
            } else {
                write(fd2[1], "gagné\n", 7);
                break;
            }

            nombre_tours++;
            if(nombre_tours == MAX_TOUR){
                printf("[fils] victoire du fils, le pere a dépassé le nombre de tentatives autorisee");
            }
        }

        close(fd1[0]);
        close(fd2[1]);
        exit(0);
    }

    // Processus parent
    else {
        char buffer[BUFFER_SIZE];
        int choix_joueur, nombre_tours = 0;

        close(fd1[0]);
        close(fd2[1]);

        while (1) {
            // Lecture du choix du joueur
            
            choix_joueur = (rand() % 10) + 1;
            sprintf(buffer, "%d", choix_joueur);
            write(fd1[1], buffer, strlen(buffer) + 1);

            // Lecture de la réponse du fils
            read(fd2[0], buffer, BUFFER_SIZE);
            printf("[parent] Réponse : %s", buffer);

            // Vérification de la réponse
            if (strcmp(buffer, "gagné\n") == 0) {
                break;
            }

            nombre_tours++;
            if(nombre_tours == MAX_TOUR){
                break;
            }
        }

        if(nombre_tour != MAX_TOUR){
            printf("[parent] victoire du pid=%d en %d tours.\n", getpid(), nombre_tours);
        }

        close(fd1[1]);
        close(fd2[0]);
        exit(0);
    }

    return 0;
}