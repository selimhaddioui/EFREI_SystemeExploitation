#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>

#define BUFFER_SIZE 25
#define MAX_TOUR 5

int nombre_tours = 0;

int main() {
    int fd1[2], fd2[2];
    pid_t pid;

    // Création des pipes
    if (pipe(fd1) == -1 || pipe(fd2) == -1) {
        printf("Erreur lors de la création des pipes.\n");
        exit(1);
    }

    // Création du processus fils
    pid = fork();

    if (pid < 0) {
        printf("Erreur lors de la création du processus fils.\n");
        exit(1);
    }

    // Processus fils
    else if (pid == 0) {
        char buffer[BUFFER_SIZE];
        int nombre_aleatoire, choix_joueur;

        close(fd1[1]);
        close(fd2[0]);

        // Génération d'un nombrfe aléatoire entre 1 et 10
        srand(getpid());
        nombre_aleatoire = (rand() % 10) + 1;

        while (1) {
            // Lecture du choix du joueur
            read(fd1[0], buffer, BUFFER_SIZE);
            choix_joueur = atoi(buffer);
            nombre_tours++;
            // Comparaison avec le nombre aléatoire
            if (choix_joueur < nombre_aleatoire) {
                write(fd2[1], "plus grand", 11);
            } else if (choix_joueur > nombre_aleatoire) {
                write(fd2[1], "plus petit", 11);
            } else {
                printf("Gagné en %d tours\n", nombre_tours);
                break;
            }

        }

        close(fd1[0]);
        close(fd2[1]);
        exit(0);
    }

    // Processus parent
    else {
        char buffer[BUFFER_SIZE];
        int choix_joueur;

        close(fd1[0]);
        close(fd2[1]);

        while (1) {
            // Lecture du choix du joueur
            nombre_tours++;
            printf("tour n°%d\n", nombre_tours);
            if(nombre_tours == MAX_TOUR){
               printf("defaite trop de tentative!\n");
                break;
            }
            choix_joueur = (rand() % 10) + 1;
            sprintf(buffer, "%d", choix_joueur);
            write(fd1[1], buffer, strlen(buffer) + 1);

            // Lecture de la réponse du fils
            read(fd2[0], buffer, BUFFER_SIZE);
            
            // Vérification de la réponse
            if (strcmp(buffer, "gagné\n") == 0) {
                break;
            }
            printf("[parent] Réponse du fils : %s que %d\n", buffer, choix_joueur);


        }

        close(fd1[1]);
        close(fd2[0]);
        exit(0);
    }

    return 0;
}